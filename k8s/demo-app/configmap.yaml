apiVersion: v1
kind: ConfigMap
metadata:
  name: demo-app-code
  namespace: observability
data:
  demo-app.py: |
    from flask import Flask
    from prometheus_client import Counter, generate_latest, CONTENT_TYPE_LATEST
    from prometheus_client import start_http_server
    from opentelemetry import trace
    from opentelemetry.sdk.resources import Resource
    from opentelemetry.sdk.trace import TracerProvider
    from opentelemetry.sdk.trace.export import BatchSpanProcessor
    from opentelemetry.exporter.otlp.proto.http.trace_exporter import OTLPSpanExporter
    from opentelemetry.instrumentation.flask import FlaskInstrumentor
    import time

    app = Flask(__name__)

    REQUESTS = Counter("http_requests_total", "Total HTTP Requests")

    trace.set_tracer_provider(
        TracerProvider(resource=Resource.create({"service.name": "demo-app"}))
    )
    tracer = trace.get_tracer(__name__)

    otlp_exporter = OTLPSpanExporter(endpoint="http://otel-collector:4318/v1/traces")
    span_processor = BatchSpanProcessor(otlp_exporter)
    trace.get_tracer_provider().add_span_processor(span_processor)

    FlaskInstrumentor().instrument_app(app)

    @app.route("/")
    def hello():
        REQUESTS.inc()
        with tracer.start_as_current_span("demo-request"):
            time.sleep(0.2)
            return "Hello, OTel Demo!"

    @app.route("/metrics")
    def metrics():
        return generate_latest(), 200, {'Content-Type': CONTENT_TYPE_LATEST}

    @app.route("/health")
    def health():
        return "OK", 200

    if __name__ == "__main__":
        start_http_server(8000)
        app.run(host="0.0.0.0", port=8080)
